name: Qiskit Neko Integration Tests
on:
  push:
  pull_request:
    branches: ['main', 'stable/*']
concurrency:
  group: ${{ github.repository }}-${{ github.ref }}-${{ github.head_ref }}-${{ github.workflow }}
  # Only cancel in PR mode.  In push mode, don't cancel so we don't see spurious test "failures".
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}
jobs:
  neko:
    if: github.repository_owner == 'Qiskit'
    name: Qiskit Neko Integration Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout base repository
        uses: actions/checkout@v5
        with:
          sparse-checkout: |
            constraints.txt
          sparse-checkout-cone-mode: false
      - name: preinstall dependencies
        run: |
          pip install -U setuptools pip
          pip install stestr>=3.2.0 -c constraints.txt
        shell: bash
      - uses: Qiskit/qiskit-neko@main
        with:
          test_selection: terra
          # We have to forcibly uninstall any old version of qiskit or qiskit-terra during the
          # changeover, because it's not possible to safely upgrade an existing installation to 1.0.
          repo_install_command: "pip uninstall -y qiskit qiskit-terra && pip install -c constraints.txt ."
