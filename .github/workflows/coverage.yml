name: Coverage report
on:
  push:
  pull_request:
    branches: ['main']
concurrency:
  group: ${{ github.repository }}-${{ github.ref }}-${{ github.head_ref }}-${{ github.workflow }}
  cancel-in-progress: true
jobs:
  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        name: Install Python
        with:
          python-version: '3.8'
      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          profile: default
          components: llvm-tools-preview
      - name: Install dependencies
        run: |
            pip install coveragepy-lcov
            sudo apt-get install lcov
      - name: Download grcov for rust coverage
        run: curl -L https://github.com/mozilla/grcov/releases/download/v0.8.11/grcov-x86_64-unknown-linux-gnu.tar.bz2 | tar jxf -
      - name: Build and install qiskit-terra
        run: pip install -e .
        env:
          CARGO_INCREMENTAL: 0
          RUSTFLAGS: "-Cinstrument-coverage"
          LLVM_PROFILE_FILE: "qiskit-%p-%m.profraw"
      - name: Run coverage report
        run: |
          set -e
          pip install -r requirements-dev.txt qiskit-aer
          stestr run
          coverage3 run --source qiskit --parallel-mode ./tools/verify_parallel_map.py
          coverage3 combine
          coverage3 report
        env:
          QISKIT_TEST_CAPTURE_STREAMS: 1
          QISKIT_PARALLEL: FALSE
          PYTHON: "coverage3 run --source qiskit --parallel-mode"
      - name: Convert to lcov
        run: coveragepy-lcov --output_file_path python.info
      - name: Run grcov for rust-coverage
        run: |
          set -e
          ./grcov . --binary-path ./target/debug/ -s . -t lcov --branch --ignore-not-existing --ignore "/*" -o ./rust.info
      - name: Combine Coverage
        run: lcov --add-tracefile python.info -a rust.info -o coveralls.info
      - name: Coveralls
        uses: coverallsapp/github-action@master
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path-to-lcov: coveralls.info
