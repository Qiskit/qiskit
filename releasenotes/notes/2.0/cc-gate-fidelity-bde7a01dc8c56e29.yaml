---
upgrade:
  - |
    Increased the minimum threshold for when gates are assumed to be the identity in
    :class:`.RemoveIdentityEquivalent` from machine epsilon to ``1e-12`` to
    account for round-off errors in the fidelity calculation and for consistency with the
    other classes, such as :class:`.CommutationAnalysis` and :class:`.TwoQubitWeylDecomposition`.
  - |
    Updated the metric used to check commutations in :class:`.CommutationChecker`.
    Two gates are assumed to commute if the average gate fidelity of the commutation is
    above ``(1 - 1e-12)``. This value is chosen to account for round-off errors in the
    fidelity calculation and for consistency with :class:`.RemoveIdentityEquivalent` and
    :class:`.TwoQubitWeylDecomposition`. See the class docstring for more information.
fixes:
  - |
    Fixed an inconsistency in the transpilation process when handling close-to-identity gates,
    where these gates were evaluated to commute with everything by :class:`.CommutationAnalysis`, 
    but not removed by :class:`.RemoveIdentityEquivalent`. The underlying 
    issue was caused by :class:`.RemoveIdentityEquivalent`
    and :class:`.CommutationAnalysis` (and, by extension, :class:`.CommutativeInverseCancellation`) 
    using different metrics.
    Both now use the average gate fidelity and the same threshold to assess whether a gate
    should be treated as identity (such as a rotation gate with very small angle). See the 
    docstrings of these classes for more information.
    Fixed `#13547 <https://github.com/Qiskit/qiskit/issues/13547>`__.
features_circuits:
  - |
    Added a new ``approximation_degree`` argument to :meth:`.CommutationChecker.commute` and
    :meth:`.CommutationChecker.commute_nodes`. This argument allows you to set the approximation threshold
    for when gates are evaluated to commute. See the docstring of :class:`.CommutationChecker` for more 
    information.
features_transpiler:
  - |
    Added a new ``approximation_degree`` argument to :class:`.CommutationAnalysis`. This argument 
    allows you to set the approximation threshold for when gates are evaluated to commute. See the class docstring 
    for more information.

