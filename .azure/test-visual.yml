parameters:
  - name: "pythonVersion"
    type: string
    displayName: "Version of Python to use"

jobs:
  - job: "Visual_Tests_Python${{ replace(parameters.pythonVersion, '.', '') }}"
    displayName: "Visual Tests Using Python ${{ parameters.pythonVersion }}"
    pool: {vmImage: 'ubuntu-latest'}

    variables:
      QISKIT_SUPPRESS_PACKAGING_WARNINGS: Y
      PIP_CACHE_DIR: $(Pipeline.Workspace)/.pip
      QISKIT_TEST_CAPTURE_STREAMS: 1

    steps:
      - task: UsePythonVersion@0
        inputs:
          versionSpec: '${{ parameters.pythonVersion }}'
        displayName: 'Use Python ${{ parameters.pythonVersion }}'

      - task: Cache@2
        inputs:
          key: 'stestr | "$(Agent.OS)" | "${{ parameters.pythonVersion }}" | "$(Build.BuildNumber)"'
          restoreKeys: |
            stestr | "$(Agent.OS)" | "${{ parameters.pythonVersion }}"
            stestr | "$(Agent.OS)"
            stestr
          path: .stestr
        displayName: "Cache stestr"

      - bash: |
          set -e
          python -m pip install --upgrade pip setuptools wheel virtualenv
          virtualenv test-job
        displayName: "Prepare venv"
        
      - bash: |
          set -e
          virtualenv image_tests
          image_tests/bin/python -m pip install -U \
            -c constraints.txt \
            -r requirements.txt \
            -e ".[visualization]"
          sudo apt-get update
          sudo apt-get install -y graphviz pandoc
          image_tests/bin/pip check
        displayName: 'Install dependencies'

      - bash: image_tests/bin/python -m unittest discover -v test/visual
        displayName: 'Run image test'

      - task: ArchiveFiles@2
        displayName: Archive circuit failure diffs
        inputs:
          rootFolderOrFile: 'test/visual/mpl/circuit/circuit_failures'
          includeRootFolder: false
          archiveType: tar
          archiveFile: '$(Build.ArtifactStagingDirectory)/circuit_failures.tar.gz'
          verbose: true
        condition: failed()

      - task: ArchiveFiles@2
        displayName: Archive graph failure diffs
        inputs:
          rootFolderOrFile: 'test/visual/mpl/graph/graph_failures'
          includeRootFolder: false
          archiveType: tar
          archiveFile: '$(Build.ArtifactStagingDirectory)/graph_failures.tar.gz'
          verbose: true
        condition: failed()

      - task: ArchiveFiles@2
        displayName: Archive circuit results
        inputs:
          rootFolderOrFile: 'test/visual/mpl/circuit/circuit_results'
          archiveType: tar
          archiveFile: '$(Build.ArtifactStagingDirectory)/circuit_results.tar.gz'
          verbose: true
        condition: failed()

      - task: ArchiveFiles@2
        displayName: Archive graph results
        inputs:
          rootFolderOrFile: 'test/visual/mpl/graph/graph_results'
          archiveType: tar
          archiveFile: '$(Build.ArtifactStagingDirectory)/graph_results.tar.gz'
          verbose: true
        condition: failed()

      - task: PublishBuildArtifacts@1
        displayName: 'Publish image test failure diffs'
        inputs:
          pathtoPublish: '$(Build.ArtifactStagingDirectory)'
          artifactName: 'image_test_failure_img_diffs'
          Parallel: true
          ParallelCount: 8
        condition: failed()


        