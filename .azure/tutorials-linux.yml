parameters:
  - name: "pythonVersion"
    type: string
    displayName: "Version of Python to test"

jobs:
  - job: "Tutorials"
    pool: {vmImage: 'ubuntu-latest'}

    variables:
      PIP_CACHE_DIR: $(Pipeline.Workspace)/.pip

    steps:
      - task: UsePythonVersion@0
        inputs:
          versionSpec: '${{ parameters.pythonVersion }}'
        displayName: 'Use Python ${{ parameters.pythonVersion }}'

      - bash: |
          set -e
          python -m pip install --upgrade pip setuptools wheel
          python -m pip install -U "tox<4.4.0"
          sudo apt-get update
          sudo apt-get install -y graphviz pandoc

          git clone https://github.com/Qiskit/qiskit-tutorials --depth=1
          mv qiskit-tutorials/tutorials/algorithms/** docs/tutorials/algorithms
          mv qiskit-tutorials/tutorials/circuits/** docs/tutorials/circuits
          mv qiskit-tutorials/tutorials/circuits_advanced/** docs/tutorials/circuits_advanced
          mv qiskit-tutorials/tutorials/operators/** docs/tutorials/operators
        displayName: 'Install dependencies'

      - bash: |
          tox -e tutorials
          mkdir -p updated-tutorials/{algorithms,circuits,circuits_advanced,operators}
          mv docs/tutorials/algorithms/*.nbconvert.ipynb updated-tutorials/algorithms/
          mv docs/tutorials/circuits/*.nbconvert.ipynb updated-tutorials/circuits/
          mv docs/tutorials/circuits_advanced/*.nbconvert.ipynb updated-tutorials/circuits_advanced/
          mv docs/tutorials/operators/*.nbconvert.ipynb updated-tutorials/operators/
        displayName: "Execute tutorials"

      - task: ArchiveFiles@2
        inputs:
          rootFolderOrFile: 'updated-tutorials'
          archiveType: tar
          archiveFile: '$(Build.ArtifactStagingDirectory)/updated-tutorials.tar.gz'
          verbose: true

      - task: PublishBuildArtifacts@1
        displayName: 'Publish updated tutorials'
        inputs:
          pathtoPublish: '$(Build.ArtifactStagingDirectory)'
          artifactName: 'updated-tutorials'
          Parallel: true
          ParallelCount: 8
